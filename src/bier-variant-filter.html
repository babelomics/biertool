<link rel="import" href="../bower_components/stevia-elements/src/filter/stv-filter-position.html">
<link rel="import" href="../bower_components/stevia-elements/src/filter/stv-filter-scores.html">
<link rel="import" href="../bower_components/stevia-elements/src/filter/stv-filter-conservation.html">
<link rel="import" href="../bower_components/stevia-elements/src/filter/stv-filter-consequencetypes.html">
<link rel="import" href="../bower_components/stevia-elements/src/ontology/stv-go.html">
<link rel="import" href="../bower_components/stevia-elements/src/ontology/stv-hpo.html">
<link rel="import" href="../bower_components/stevia-elements/src/stv-diseases-search.html">

<dom-module id="bier-variant-filter">
    <style is="custom-style" include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;
            width: 260px;
            padding-left: 10px;
        }

        #filter_form {
            overflow-y: auto;
            height: 100%;
            margin: 0px;
        }

        #bar {
            padding: 0 3px 5px 0;
        }

        #bar > .stv-btn {
            margin: 0px 2px;
        }

        .segregation.sampleName {
            width: 100px;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }

        input.segregation,
        .segregationValue {
            margin-left: 3px;
        }

        textarea {
            resize: none;
            width: 100%;
        }

        stv-tooltip::shadow #messageInfo::shadow {
            height: 500px;
            width: 500px;
            background-color: #e2e9e9;
            border: 1px solid #e2e9e9;
            color: black;
            font-style: normal;
        }

        stv-tooltip::shadow .closeInfo::shadow {
            margin-left: 490px;
        }

        #filterHistoryTable > div:hover {
            background-color: #8ba7a7;
            border: 1px solid #8ba7a7;
        }

        #filter-name {
            text-overflow: ellipsis;
            width: 300px;
            white-space: nowrap;
            overflow: hidden;
        }

        .tit {
            margin-top: 10px;
            border-bottom: 1px solid #445D76;
            font-weight: bold;
        }

        .name {
            width: 300px;
        }

        .num {
            width: 100px;
        }

        .clear-but {
            width: 100px;
            background-color: #f0f4f4 !important;
        }

        .searchBut {
            width: 100px;
            font-size: 12px;
            color: #445D76;
            margin: 3px;
        }

        .minus {
            color: #2F65F4;
            font-size: 12px;
            padding: 0 2px;
            cursor: pointer;
        }

        .minus:hover {
            color: #445D76;
            font-weight: bold;
        }

        .popus {
            font-weight: bold;
            cursor: pointer;
        }

        #hpoPanel,
        #goPanel,
        #createNewPanel {
            min-width: 700px;
            min-height: 500px;
            height: calc(100vh - 300px);
            width: 60%;
            font-size: 12px;
        }

        .exclude {
            color: #666;
            margin-bottom: 5px;
        }

        .butstyle {
            border-radius: 4px;
            width: 100px;
            background-color: var(--dark-button-color) !important;
            color: var(--text-primary-color) !important;
        }

        .butstyle:hover {
            background-color: var(--light-button-color) !important;
        }

        #filterHistoryTooltip {
            border-radius: 4px;
            background-color: var(--dark-button-color) !important;
            color: var(--text-primary-color) !important;
        }

        #filterHistoryTooltip:hover {
            background: var(--accent-color) !important;
        }

        stv-select {
            width: 45px;
            margin-right: 3px;
            align-self: center;
        }

        paper-slider.sliderBar {
            color: #a0a0a0;
            --paper-slider-knob-color: #445D76;
            --paper-slider-active-color: #445D76;
            --paper-slider-pin-color: #445D76;
            --paper-input-container-focus-color: #445D76;
            width: 125%;
        }

        paper-slider::shadow #input {
            width: calc(20vh - 40px);
            font-size: 13px;
        }

        .tissueList {
            height: 250px;
            overflow-y: auto;
            width: 200px;
            margin-top: 10px;
        }

        .linage {
            fill: none;
            stroke: #000;
        }

        .marriage {
            fill: none;
            stroke: black;
        }

        .man {
            border: 1px solid black;
            background-color: white;
        }

        .woman {
            border: 1px solid black;
            border-radius: 10px;
            background-color: white;
        }

        .emphasis {
            font-style: italic;
        }

        p {
            padding: 0;
            margin: 0;
        }

        .proband {
            background-color: black;
            color: white;
        }
        svg {
            font: 10px sans-serif;
            height: 150px;
            width: 210px;
        }
    </style>
    <template>
        <form id="filter_form">
            <div id="bar" class="horizontal layout">
                <stv-tooltip id="filterHistoryTooltip" class="stv-btn stv-btn-shdw" title="Filters History" icon="filter">
                    <div class="stv-btn stv-btn-shdw clear-but" title="Clear Filters History" on-click="clearFiltersHistory">
                        Clear
                    </div>
                    <div class="horizontal layout flex">
                        <span class="tit num"> Date </span>
                        <span class="name tit"> Name </span>
                        <span class="tit num"> Found</span>
                    </div>
                    <div id="filterHistoryTable">
                        <template is="dom-repeat" items="{{historyFilters}}">
                            <div class="horizontal layout flex" on-click="loadFilter" data-filter="{{item.filter}}" title="{{item.name}}">
                                <span class="num">{{item.date}} </span>
                                <span id="filter-name" class="name">{{item.name}} </span>
                                <span class="num">{{item.found}}</span>
                            </div>
                        </template>
                    </div>
                </stv-tooltip>
                <div class="stv-btn stv-btn-shdw flex butstyle" on-click="clearForm">Clear</div>
                <div class="stv-btn stv-btn-shdw flex butstyle" on-click="handleSubmitClick">Search</div>
            </div>
            <stv-form-box collapsible id="segregationForm" hidden="{{!isFamilyStudy(study)}}">
                <div class="header">
                    Inheritance
                </div>
                <div class="container" style="overflow-y:auto;max-height:300px;min-height:200px">
                    <div id="inheritance" style="margin-bottom:15px;">
                        <div style="margin-bottom:5px;">Type of inheritance:</div>
                        <jso-select id="inheritanceOptions" on-change="handleInheritanceChanged">
                            <jso-option value="-">-</jso-option>
                            <jso-option value="dominant">dominant
                            </jso-option>
                            <jso-option value="recessive">recessive
                            </jso-option>
                            <jso-option value="linkedX">linked to X
                            </jso-option>
                            <jso-option value="linkedY">linked to Y
                            </jso-option>
                        </jso-select>
                    </div>
                    <div id="segregationHeader" class="horizontal layout">
                        <div class="segregation sampleName"></div>
                        <div class="segregation segregationValue flex">0/0</div>
                        <div class="segregation segregationValue flex">0/1</div>
                        <div class="segregation segregationValue flex">1/1</div>
                        <div class="segregation segregationValue flex">. / .</div>
                    </div>
                    <div id="segregation" class="vertical layout">
                        <template is="dom-repeat" items="{{samples}}">
                            <div class="horizontal layout">
                                <div class="segregation sampleName" title="{{item.name}}">{{item.name}}</div>
                                <label class="stv-control flex">
                                    <input type="checkbox" name="{{item.name}}" value="0/0,0|0">
                                    <span></span>
                                </label>
                                <label class="stv-control flex">
                                    <input type="checkbox" name="{{item.name}}" value="0/1,0|1,1/0,1|0">
                                    <span></span>
                                </label>
                                <label class="stv-control flex">
                                    <input type="checkbox" name="{{item.name}}" value="1/1,1|1">
                                    <span></span>
                                </label>
                                <label class="stv-control flex">
                                    <input type="checkbox" name="{{item.name}}" value="-1/-1,-1|-1">
                                    <span></span>
                                </label>
                            </div>
                        </template>
                    </div>
                    <div id="familyPreviewDiv" class="preview" style="height: 140px;margin-top: 10px;">
                        <div class="" style="border: 1px solid grey; height:95%">
                            <div id="familyPreview"></div>
                        </div>
                    </div>
                </div>
            </stv-form-box>

            <stv-form-box collapsible collapsed hidden="{{!isPairedStudy(study)}}">
                <div class="header">
                    Somatic Filter
                </div>
                <div class="container">
                    <div class="horizontal layout">
                        <div class="segregation sampleName"></div>
                        <div class="segregation segregationValue flex">Somatic</div>
                        <div class="segregation segregationValue flex" style="margin-left:15px;">Germinal</div>
                    </div>
                    <div id="somatic" class="vertical layout">
                        <template is="dom-repeat" items="{{samples}}">
                            <div class="horizontal layout">
                                <div class="segregation sampleName" title="{{item.name}}">{{item.name}}</div>
                                <label class="stv-control flex">
                                    <input class="stv" type="radio" name="{{item.name}}" data-file$="{{item.source}}" value="somatic">
                                    <span style="margin-left:15px;"></span>
                                </label>
                                <label class="stv-control flex">
                                    <input class="stv" type="radio" name="{{item.name}}" data-file$="{{item.source}}" value="germinal">
                                    <span style="margin-left:15px;"></span>
                                </label>
                            </div>
                        </template>
                    </div>
                </div>
            </stv-form-box>

            <stv-filter-position id="filterPosition" collapsible enable-importbed enable-snpid enable-genepanel style="font-size:12px"></stv-filter-position>

            <stv-form-box collapsible collapsed>
                <div class="header">
                    Type
                </div>
                <div id="type_op" class="container">
                    <div style="margin-left:5px" class="horizontal layout">
                        <label class="stv-control">
                            <input class="stv" value="SNV,SNP" type="checkbox">
                            <span>SNV</span>
                        </label>
                        <label class="stv-control" style="margin-left:14px">
                            <input class="stv" value="MNV" type="checkbox">
                            <span>MNV</span>
                        </label>
                    </div>
                    <div style="margin-left:5px" class="horizontal layout">
                        <label class="stv-control">
                            <input class="stv" value="INDEL" type="checkbox">
                            <span>INDEL</span>
                        </label>
                        <label class="stv-control" style="margin-left:2px">
                            <input class="stv" value="SV" type="checkbox">
                            <span>SV</span>
                        </label>
                    </div>
                    <div style="margin-left:5px" class="horizontal layout">
                        <label class="stv-control">
                            <input class="stv" value="CNV" type="checkbox">
                            <span>CNV</span>
                        </label>
                    </div>
                </div>
            </stv-form-box> 

            <stv-form-box collapsible collapsed>
                <div class="header">
                    Population Freqs.
                </div>
                <div class="container">
                    <i class$="{{phase_3}}" on-click="handleCollapseAction" data-type="phase_3"></i>
                    <label class="stv popus" on-click="handleCollapseAction" data-type="phase_3">1000 Genomes population phase 3</label>
                    <div id="phase_3" hidden>
                        <label class="stv">All populations MAF [ALL]</label>
                        <div class="horizontal layout">
                            <stv-select name="1000GENOMES_phase_3_ALL_op" id="1000GENOMES_phase_3_ALL_op">
                                <stv-option value="<" selected>
                                    <</stv-option>
                                        <stv-option value="<=">
                                            <=</stv-option>
                                                <stv-option value=">">></stv-option>
                                                <stv-option value=">=">>=</stv-option>
                            </stv-select>
                            <paper-slider pin min="0" max="1" step="0.000001" value="0" class="sliderBar" id="1000GENOMES_phase_3_ALL" editable on-value-change="sliderChange"></paper-slider>
                        </div>
                        <label class="stv">American MAF [AMR]</label>
                        <div class="horizontal layout">
                            <stv-select name="1000GENOMES_phase_3_AMR_op" id="1000GENOMES_phase_3_AMR_op">
                                <stv-option value="<" selected>
                                    <</stv-option>
                                        <stv-option value="<=">
                                            <=</stv-option>
                                                <stv-option value=">">></stv-option>
                                                <stv-option value=">=">>=</stv-option>
                            </stv-select>
                            <paper-slider pin min="0" max="1" step="0.000001" value="0" class="sliderBar" id="1000GENOMES_phase_3_AMR" editable on-value-change="sliderChange"></paper-slider>
                        </div>
                        <label class="stv">South Asian MAF [SAS]</label>
                        <div class="horizontal layout">
                            <stv-select name="1000GENOMES_phase_3_SAS_op" id="1000GENOMES_phase_3_SAS_op">
                                <stv-option value="<" selected>
                                    <</stv-option>
                                        <stv-option value="<=">
                                            <=</stv-option>
                                                <stv-option value=">">></stv-option>
                                                <stv-option value=">=">>=</stv-option>
                            </stv-select>
                            <paper-slider pin min="0" max="1" step="0.000001" value="0" class="sliderBar" id="1000GENOMES_phase_3_SAS" editable on-value-change="sliderChange"></paper-slider>
                        </div>
                        <label class="stv">East Asian MAF [EAS]</label>
                        <div class="horizontal layout">
                            <stv-select name="1000GENOMES_phase_3_EAS_op" id="1000GENOMES_phase_3_EAS_op">
                                <stv-option value="<" selected>
                                    <</stv-option>
                                        <stv-option value="<=">
                                            <=</stv-option>
                                                <stv-option value=">">></stv-option>
                                                <stv-option value=">=">>=</stv-option>
                            </stv-select>
                            <paper-slider pin min="0" max="1" step="0.000001" value="0" class="sliderBar" id="1000GENOMES_phase_3_EAS" editable on-value-change="sliderChange"></paper-slider>
                        </div>
                        <label class="stv">African MAF [AFR]</label>
                        <div class="horizontal layout">
                            <stv-select name="1000GENOMES_phase_3_AFR_op" id="1000GENOMES_phase_3_AFR_op">
                                <stv-option value="<" selected>
                                    <</stv-option>
                                        <stv-option value="<=">
                                            <=</stv-option>
                                                <stv-option value=">">></stv-option>
                                                <stv-option value=">=">>=</stv-option>
                            </stv-select>
                            <paper-slider pin min="0" max="1" step="0.000001" value="0" class="sliderBar" id="1000GENOMES_phase_3_AFR" editable on-value-change="sliderChange"></paper-slider>
                        </div>
                        <label class="stv">European MAF [EUR]</label>
                        <div class="horizontal layout">
                            <stv-select name="1000GENOMES_phase_3_EUR_op" id="1000GENOMES_phase_3_EUR_op">
                                <stv-option value="<" selected>
                                    <</stv-option>
                                        <stv-option value="<=">
                                            <=</stv-option>
                                                <stv-option value=">">></stv-option>
                                                <stv-option value=">=">>=</stv-option>
                            </stv-select>
                            <paper-slider pin min="0" max="1" step="0.000001" value="0" class="sliderBar" id="1000GENOMES_phase_3_EUR" editable on-value-change="sliderChange"></paper-slider>
                        </div>
                    </div>
                    <br>
                    <i class$="{{esp_6500}}" on-click="handleCollapseAction" data-type="esp_6500"></i>
                    <label class="stv popus" on-click="handleCollapseAction" data-type="esp_6500">ESP 6500</label>
                    <div id="esp_6500" hidden>
                        <label class="stv">European american MAF</label>
                        <div class="horizontal layout">
                            <stv-select name="ESP_6500_EA_op" id="ESP_6500_EA_op">
                                <stv-option value="<" selected>
                                    <</stv-option>
                                        <stv-option value="<=">
                                            <=</stv-option>
                                                <stv-option value=">">></stv-option>
                                                <stv-option value=">=">>=</stv-option>
                            </stv-select>
                            <paper-slider pin min="0" max="1" step="0.000001" value="0" class="sliderBar" id="ESP_6500_EA" editable on-value-change="sliderChange"></paper-slider>
                        </div>
                        <label class="stv">African american MAF</label>
                        <div class="horizontal layout">
                            <stv-select name="ESP_6500_AA_op" id="ESP_6500_AA_op">
                                <stv-option value="<" selected>
                                    <</stv-option>
                                        <stv-option value="<=">
                                            <=</stv-option>
                                                <stv-option value=">">></stv-option>
                                                <stv-option value=">=">>=</stv-option>
                            </stv-select>
                            <paper-slider pin min="0" max="1" step="0.000001" value="0" class="sliderBar" id="ESP_6500_AA" editable on-value-change="sliderChange"></paper-slider>
                        </div>
                    </div>
                    <br>
                    <i class$="{{exac}}" on-click="handleCollapseAction" data-type="exac"></i>
                    <label class="stv popus" on-click="handleCollapseAction" data-type="exac">EXAC</label>
                    <div id="exac" hidden>
                        <label class="stv">EXAC MAF</label>
                        <div class="horizontal layout">
                            <stv-select name="EXAC_ALL_op" id="EXAC_ALL_op">
                                <stv-option value="<" selected>
                                    <</stv-option>
                                        <stv-option value="<=">
                                            <=</stv-option>
                                                <stv-option value=">">></stv-option>
                                                <stv-option value=">=">>=</stv-option>
                            </stv-select>
                            <paper-slider pin min="0" max="1" step="0.000001" value="0" class="sliderBar" id="EXAC_ALL" editable on-value-change="sliderChange"></paper-slider>
                        </div>
                    </div>
                </div>
            </stv-form-box> 

            <stv-filter-scores id="filterScores" collapsible collapsed style="font-size:12px"></stv-filter-scores>

            <stv-filter-conservation id="filterConservation" collapsible collapsed style="font-size:12px"></stv-filter-conservation>

            <stv-filter-consequencetypes id="filterCT" collapsible collapsed style="font-size:12px"></stv-filter-consequencetypes>

            <stv-form-box collapsible collapsed>
                <div class="header">
                    Gene Ontology
                </div>
                <div class="container">
                    <label class="stv">Filter by GO id:</label>
                    <div class="horizontal layout" hidden>
                        <label class="exclude">Exclude Selected</label>
                        <label>
                            <input id="goExclude" value="exclude" type="checkbox" class="stv">
                            <span></span>
                        </label>
                    </div>
                    <textarea class="stv" id="go" name="go" value="{{goSearch::change}}" rows="3" placeholder="GO:0000001,GO:0001177" disabled>
                    </textarea>
                    <div class="horizontal layout" style="color: #666;margin-top:2px;line-height:28px;">
                        Search GO: &nbsp;
                        <div class="stv-btn stv-btn-shdw searchBut" on-click="showGO" title="Search GO"><i class="fa fa-search" aria-hidden="true"></i>
                        </div>
                    </div>
                </div>
            </stv-form-box>
            <stv-form-box collapsible collapsed>
                <div class="header">
                    Human Phenotype Ontology
                </div>
                <div class="container">
                    <label class="stv">Filter by HPO id:</label>
                    <div class="horizontal layout" hidden>
                        <label class="exclude">Exclude Selected</label>
                        <label>
                            <input id="hpoExclude" value="exclude" type="checkbox" class="stv">
                            <span></span>
                        </label>
                    </div>
                    <textarea class="stv" id="hpo" name="hpo" value="{{hpoSearch::change}}" rows="3" placeholder="HP:0000001,HP:3000079" disabled>
                    </textarea>
                    <div class="horizontal layout" style="color: #666;margin-top:2px;line-height:28px;">
                        Search HPO: &nbsp;
                        <div class="stv-btn stv-btn-shdw searchBut" on-click="showHPO" title="Search HPO"><i class="fa fa-search" aria-hidden="true"></i>
                        </div>
                    </div>
                </div>
            </stv-form-box>

            <stv-form-box collapsible collapsed>
                <div class="header">
                    Diagnostic by disease
                </div>
                <div class="container">
                    <label class="stv">Selected diseases:</label>
                    <textarea class="stv" id="disease" name="disease" value="{{diseaseSearch::change}}" rows="3" placeholder="Carcinoma, Retinitis Pigmentosa" disabled>
                    </textarea>
                    <div class="horizontal layout" style="color: #666;margin-top:2px;line-height:28px;">
                        Search disease: &nbsp;
                        <div class="stv-btn stv-btn-shdw searchBut" on-click="showCreatePanel" title="Search disease"><i class="fa fa-search" aria-hidden="true"></i>
                        </div>
                    </div>
                </div>
            </stv-form-box>
            <stv-form-box collapsible collapsed>
                <div class="header">
                    Tissue
                </div>
                <div class="container">
                    <label class="stv-control flex">
                        <input class="stv" type="radio" name="tissue" value="protein" checked>
                        <span style="margin-left:15px;">Human Protein Atlas</span>
                    </label>
                    <!-- <label class="stv-control flex">
                        <input class="stv" type="radio" name="tissue" value="expression">
                        <span style="margin-left:15px;">Expresion Atlas</span>
                    </label> -->
                    <div class="tissueList">
                        <template is="dom-repeat" items="{{proteinTissues}}">
                            <label class="stv-control horizontal layout">
                                <input class="stv" value="{{item}}" data-name$="{{item.name}}" type="checkbox" name="consequence_type">
                                <span title$="{{item.name}}">{{item.name}}</span>
                            </label>
                        </template>
                    </div>
                </div>
            </stv-form-box>

            <stv-panel id="importComponent" modal closable hidden>
                <div class="header">
                    <i class="fa fa-plus-square-o"></i> Import File
                </div>
                <stv-opencga-import-file id="importFile" class="container" on-end="handleImportFile" bioformat="{{bedBioformat}}"></stv-opencga-import-file>
            </stv-panel>
            <stv-panel id="goPanel" modal closable hidden>
                <div class="header">
                    <i class="fa fa-search" aria-hidden="true"></i> Gene Ontology
                </div>
                <div class="container" style="width:100%">
                    <stv-go go-value="{{goValue}}" on-added="showGO"></stv-go>
                </div>
            </stv-panel>
            <stv-panel id="hpoPanel" modal closable hidden>
                <div class="header">
                    <i class="fa fa-search" aria-hidden="true"></i> Human Phenotype Ontology
                </div>
                <div class="container" style="width:100%">
                    <stv-hpo hpo-value="{{hpoValue}}" on-added="showHPO"></stv-hpo>
                </div>
            </stv-panel>
            <stv-panel id="createNewPanel" modal closable hidden>
                <div class="header">
                    <i class="fa fa-search" aria-hidden="true"></i> Create new Panel for diagnostic
                </div>
                <div class="container" style="width:100%">
                    <stv-diseases-search disease-value="{{diseaseValue}}" on-added="showCreatePanel"></stv-disease-search>
                </div>
            </stv-panel>
        </form>
    </template>
</dom-module>
<script>
    Polymer({
        is: "bier-variant-filter",
        properties: {
            url: {
                type: String,
                notify: true,
                value: ''
            },
            study: {
                type: Object,
                value: function() {
                    return {};
                },
                observer: 'studyChanged'
            },
            samples: {
                type: Array,
                notify: true,
                value: function() {
                    return [];
                },
                observer: 'samplesChanged'
            },
            regionValue: {
                type: String,
                notify: true,
                value: ''
            },
            geneValue: {
                type: String,
                notify: true,
                value: ''
            },
            snpIdValue: {
                type: String,
                notify: true,
                value: ''
            },
            goValue: {
                type: Array,
                notify: true,
                value: function() {
                    return [];
                },
                observer: 'goValueChanged'
            },
            goSearch: {
                type: String,
                notify: true,
                value: '',
            },
            hpoValue: {
                type: Array,
                notify: true,
                value: function() {
                    return [];
                },
                observer: 'hpoValueChanged'
            },
            hpoSearch: {
                type: String,
                notify: true,
                value: '',
            },
            diseaseValue: {
                type: Array,
                notify: true,
                value: function() {
                    return [];
                },
                observer: 'diseaseValueChanged'
            },
            diseaseSearch: {
                type: String,
                notify: true,
                value: '',
            },
            fileName: {
                type: String,
                notify: true,
                value: 'Choose file...'
            },
            consequenceTypes: {
                type: Array,
                value: function() {
                    return CONSEQUENCE_TYPES;
                }
            },
            historyFilters: {
                type: Array,
                value: function() {
                    return [];
                },
            },
            hash: {
                type: Object,
                value: function() {
                    return {};
                },
            },
            numTotalResults: {
                type: Object,
                observer: "resultsChanged"
            },
            bedBioformat: {
                type: Object,
                value: {
                    text: "BED",
                    value: "BED",
                    validator: BEDValidator
                }
            },
            query: {
                type: Object,
                notify: true,
                value: function() {
                    return {};
                },
            },
            phase_3: {
                type: String,
                value: "fa fa-angle-double-right minus"
            },
            esp_6500: {
                type: String,
                value: "fa fa-angle-double-right minus"
            },
            exac: {
                type: String,
                value: "fa fa-angle-double-right minus"
            },
            filesId: {
                type: Array,
                value: function() {
                    return [];
                },
                observer: "filesIdChanged"
            },
            proteinTissues: {
                type: Array,
                value: function() {
                    return [];
                },
                observer: "proteinTissuesChanged"
            },
            familyMap: {
                type: Array,
                observer: 'familyMapChanged'
            }
        },
        ready: function() {
            this.scopeSubtree(this.$.familyPreview, true);
            var me = this;
            if (localStorage.bioinfo_bierApp_filter_history) {
                this.hash = JSON.parse(localStorage.bioinfo_bierApp_filter_history);
                if (Array.isArray(this.hash)) {
                    localStorage.bioinfo_bierApp_filter_history = "";
                    this.hash = {};
                }
            } else {
                localStorage.bioinfo_bierApp_filter_history = [];
            }
            BiodbManager.tissue.fetch({
                query: {
                    skip: 0,
                    limit: 60
                },
                request: {
                    success: function(response) {
                        if (response.error === '' || response.error.msg == "") {
                            var aux = [];
                            for (var i = 0; i < response.result.length; i++) {
                                aux.push(response.result[i]);
                            }
                            me.set('proteinTissues', aux);
                        } else {
                            console.log(response.error.msg);
                        }
                    },
                    error: function() {
                        console.log('Server error, try again later.');
                    }
                }
            });

        },
        proteinTissuesChanged: function(neo, old) {},
        studyChanged: function(neo, old) {
            if (neo && neo.id != null) {
                // if (this.study.type == "CASE_CONTROL") {
                //     this.$.segregationForm.hidden = true;
                // } else {
                //     this.$.segregationForm.hidden = false;
                // }
                this.historyFilters = this.hash[neo.id];
                this.clearForm();
            }
        },
        isPairedStudy: function(study) {
            if (study.type != null && study.type.toUpperCase() == "PAIRED") {
                return true;
            } else {
                return false;
            }
        },
        isFamilyStudy: function(study) {
            if (study.type != null && study.type.toUpperCase() == "FAMILY") {
                return true;
            } else {
                return false;
            }
        },
        samplesChanged: function(neo, old) {
          if(neo && neo.length>0){
            this.$.familyPreviewDiv.hidden=true;
            if(neo[0].marriages!=null){
              this.$.familyPreviewDiv.hidden=false;
              if(neo[0].marriages[0]!=null && neo[0].marriages[0].spouse!=null){
                this.set('familyMap', neo);
              }else{
                this._createFamilyMap(neo);
              }
            }
          }
            this.clearForm();
        },
        _createFamilyJson: function(samples) {
            var hash = {};
            for (var i = 0; i < samples.length; i++) {
                hash[samples[i].name] = samples[i];
            }

            for (var key in hash) {
                var elem = hash[key];
                var f = elem.father;
                var m = elem.mother;

                if (f in hash) {
                    if (m in hash) {
                        hash[f] = this._addMarriage(hash[f], elem, hash[m]);
                    }
                }
                if (m in hash) {
                    if (f in hash) {
                        hash[m] = this._addMarriage(hash[m], elem, hash[f]);
                    }
                }
            }
            return hash;
        },
        _addMarriage: function(father, child, mother) {
            if (father.marriages.length == 0) {
                father.marriages.push({
                    'spouse': mother,
                    'children': []
                });
            }
            for (var i = 0; i < father.marriages.length; i++) {
                if (father.marriages[i].spouse.name == mother.name) {
                    father.marriages[i].children.push(child);
                }
            }

            return father;

        },
        _createFamilyMap: function(samples) {
            var family = this._createFamilyJson(samples);
            var familyArray = [];
            for (var key in family) {
                var elem = family[key];
                if ((elem.father == "-" || elem.mother == "-")) {
                    var flag = false;
                    for (var i = 0; i < familyArray.length; i++) {
                        var m = familyArray[i].marriages;
                        for (var j = 0; j < m.length; j++) {
                            if (m[j].spouse.name == elem.name) {
                                flag = true;
                            }
                        }
                    }
                    if (flag == false) {
                        familyArray.push(elem);
                    }
                }
            }
            this.set('familyMap', familyArray);
        },
        familyMapChanged: function(neo, old) {
            if (neo) {
                if (this.$.familyPreview.firstElementChild != null) {
                    this.$.familyPreview.removeChild(this.$.familyPreview.firstElementChild);
                }
                var arrayAux = [];
                arrayAux.push(neo[0]);

                dTree.init(arrayAux, {
                    target: this.$.familyPreview,
                    debug: false,
                    width: 385,
                    height: 395,
                    margin: {
                        top: 0,
                        right: 0,
                        bottom: 0,
                        left: 0
                    },
                    nodeWidth: 100,
                    styles: {
                        node: 'node',
                        linage: 'linage',
                        marriage: 'marriage',
                        text: 'nodeText'
                    }
                });
            }
        },
        resultsChanged: function(neo, old) {
            if (neo != -1) {
                var query = this.query;
                var numTotalResults = neo;
                /* Filter History */
                var filterHistory = [];
                if (this.study.id in this.hash) {
                    filterHistory = this.hash[this.study.id];
                }
                this.set("historyFilters", filterHistory);

                var newFilter = JSON.stringify(query);
                var _load = -1;
                for (var i = 0; i < this.historyFilters.length && _load == -1; i++) { // Check if the fitler has been selected from the history
                    var elem = this.historyFilters[i];
                    if (elem != null) {
                        var oldFilter = JSON.stringify(this.historyFilters[i].filter);
                        if (newFilter == oldFilter) {
                            _load = i;
                        }
                    }
                }

                if (_load == -1) { // This filter is new (has not been selected from the history)
                    if (query.genotype != null || query.region != null || query.gene != null || query.ids != null || query.type != "" || query['annot-population-maf'] != null || query.sift != null || query.polyphen != null || query.functional != null || query.hpo != null || query["clinical-data"] != null || query.go != null || query.conservation != null || query["annot-ct"] != null) {
                        var dateAux = new Date();
                        var minAux = dateAux.getMinutes();
                        if (minAux < 10) {
                            minAux = "0" + minAux;
                        }
                        var date = dateAux.getDate() + '/' + (dateAux.getMonth() + 1) + ' ' + dateAux.getHours() + ':' + minAux;
                        name = this.loadForm(query);
                        var found = numTotalResults;
                        var hf = {};
                        hf = {
                            date: date,
                            name: name,
                            filter: query,
                            found: found
                        };

                        var filters = new FilterHistory(20, filterHistory);
                        filters.unshift(hf);
                        this.set("historyFilters", filters);
                        this.hash[this.study.id] = this.historyFilters;

                        localStorage.bioinfo_bierApp_filter_history = JSON.stringify(this.hash);
                    }
                } else { // HistoryFilter contains this filter. We need to change the date and push to top
                    var pos = _load;

                    var filters = new FilterHistory(20, this.historyFilters);
                    var filter = filters[pos];
                    var dateAux = new Date();
                    var minAux = dateAux.getMinutes();
                    if (minAux < 10) this
                    minAux = "0" + minAux;

                    var date = dateAux.getDate() + '/' + (dateAux.getMonth() + 1) + ' ' + dateAux.getHours() + ':' + minAux;

                    filter.date = date;

                    var aux = filters[pos];
                    filters[pos] = filters[0];
                    filters[0] = aux;

                    this.set("historyFilters", filters);
                    this.hash[this.study.id] = this.historyFilters;

                    localStorage.bioinfo_bierApp_filter_history = JSON.stringify(this.hash);
                    this.clearForm();
                    this.loadForm(query);
                }
            }
        },
        goValueChanged: function(neo, old) {
            if (neo) {
                var goName = [];
                for (var i = 0; i < neo.length; i++) {
                    goName.push(neo[i].name);
                }
                this.goSearch = goName.join(",");
            }
        },
        hpoValueChanged: function(neo, old) {
            if (neo) {
                var hpoName = [];
                for (var i = 0; i < neo.length; i++) {
                    hpoName.push(neo[i].name);
                }
                this.hpoSearch = hpoName.join(",");
            }
        },
        diseaseValueChanged: function(neo, old) {
            if (neo) {
                var diseaseName = [];
                for (var i = 0; i < neo.length; i++) {
                    diseaseName.push(neo[i].phenotype);
                }
                this.diseaseSearch = diseaseName.join(",");
            }
        },
        handleFeatureSelected: function(e) {
            var item = e.detail;
            if (item) {
                var values = this.$.gene.value.split(',').filter(function(el) {
                    return el.length != 0
                });
                values.push(item.name);
                values = values.filter(function(item, index, inputArray) {
                    return inputArray.indexOf(item) == index;
                });
                this.$.gene.value = values.join(",");
            }
        },
        clearForm: function() {
            // this.url = "";
            /* samples */
            this.$.inheritanceOptions.value = "-";
            var els = this.$.segregation.querySelectorAll("input:checked");
            for (var i = 0; i < els.length; i++) {
                els[i].checked = false;
            }

            //SomaticVsGerminal
            var els = this.$.somatic.querySelectorAll("input");
            for (var i = 0; i < els.length; i++) {
                els[i].checked = false;
            }

            // GO
            this.$.go.value = "";
            this.goValue = "";
            this.goSearch = "";
            this.$.goExclude.checked = false;
            // HPO
            this.$.hpo.value = "";
            this.hpoValue = "";
            this.hpoSearch = "";
            this.$.hpoExclude.checked = false;
            // Diseases
            this.$.disease.value = "";
            this.diseaseValue = "";
            this.diseaseSearch = "";

            this.$.filterPosition.clear();

            // Type
            var types = this.$.type_op.querySelectorAll("input:checked");
            for (var i = 0; i < types.length; i++) {
                var type = types[i];
                type.checked = false;
            }

            // Freqs

            this.$["1000GENOMES_phase_3_ALL"].value = 0;
            this["1000GENOMES_phase_3_ALL"] = "";
            this.$["1000GENOMES_phase_3_ALL_op"].value = "<";
            this.$["1000GENOMES_phase_3_AMR"].value = 0;
            this["1000GENOMES_phase_3_AMR"] = "";
            this.$["1000GENOMES_phase_3_AMR_op"].value = "<";
            this.$["1000GENOMES_phase_3_SAS"].value = 0;
            this["1000GENOMES_phase_3_SAS"] = "";
            this.$["1000GENOMES_phase_3_SAS_op"].value = "<";
            this.$["1000GENOMES_phase_3_EAS"].value = 0;
            this["1000GENOMES_phase_3_EAS"] = "";
            this.$["1000GENOMES_phase_3_EAS_op"].value = "<";
            this.$["1000GENOMES_phase_3_AFR"].value = 0;
            this["1000GENOMES_phase_3_AFR"] = "";
            this.$["1000GENOMES_phase_3_AFR_op"].value = "<";
            this.$["1000GENOMES_phase_3_EUR"].value = 0;
            this["1000GENOMES_phase_3_EUR"] = "";
            this.$["1000GENOMES_phase_3_EUR_op"].value = "<";

            this.$["ESP_6500_EA"].value = 0;
            this["ESP_6500_EA"] = "";
            this.$["ESP_6500_EA_op"].value = "<";
            this.$["ESP_6500_AA"].value = 0;
            this["ESP_6500_AA"] = "";
            this.$["ESP_6500_AA_op"].value = "<";
            this.$["EXAC_ALL"].value = 0;
            this["EXAC_ALL"] = "";
            this.$["EXAC_ALL_op"].value = "<";

            // Sift
            // Polyphen
            // cadd
            this.$.filterScores.clear();

            // Phylop
            // Phastcons
            this.$.filterConservation.clear();

            /* Consequence Types */
            this.$.filterCT.clear();
        },
        handleSubmitClick: function() {
            var me = this;
            this.$.filterPosition.checkGene(function(geneQuery) {
                me.submitForm(geneQuery);
            });
        },
        submitForm: function(geneQuery) {
            var query = {};

            // Region
            var regionQuery = this.$.filterPosition.checkRegion();
            if (regionQuery == -1) {
                return;
            } else if (regionQuery != null) {
                query["region"] = regionQuery;
            }

            // SNPId
            var idsQuery = this.$.filterPosition.checkSNPId();
            if (idsQuery != null) {
                query["ids"] = idsQuery;
            }

            // Genes
            // var geneQuery = this.$.filterPosition.checkGene();
            if (geneQuery == -1) {
                return;
            } else if (geneQuery != null) {
                query["gene"] = geneQuery;
            }

            //SomaticVsGerminal
            var els = this.$.somatic.querySelectorAll("input");
            var querySom = [];
            var queryaux = [];
            for (var i = 0; i < els.length; i++) {
                var el = els[i];
                if (el.checked == true) {
                    if (el.value == "germinal") {
                        queryaux.push(el.name + ":germinal");
                        querySom.push(el.name + ":" + "0/0,0|0");
                    } else if (el.value == "somatic") {
                        queryaux.push(el.name + ":somatic");
                        querySom.push(el.name + ":" + "0/1,0|1,1/0,1|0,1/1,1|1");
                    }
                }
            }
            if (querySom.length > 0) {
                query['somatic'] = queryaux.join(";");
                query.genotype = querySom.join(";");
            }

            // GO
            var gosMap = {};
            for (var i = 0; i < this.goValue.length; i++) {
                gosMap[this.goValue[i].id] = true;
                if (this.goValue[i].children != null) {
                    if (Object.keys(this.goValue[i].children).length > 0) {
                        for (var j = 0; j < this.goValue[i].children.length; j++) {
                            this.goValue.push(this.goValue[i].children[j]);
                        }
                    }
                }
            }
            if (this.goSearch != "") {
                if (this.goValue == "") {
                    query["go"] = this.goSearch;
                } else {
                    query["go"] = Object.keys(gosMap).join(",");
                }
            }

            // HPO
            var hposMap = {};
            for (var i = 0; i < this.hpoValue.length; i++) {
                hposMap[this.hpoValue[i].id] = true;
                if (this.hpoValue[i].children != null) {
                    if (Object.keys(this.hpoValue[i].children).length > 0) {
                        for (var j = 0; j < this.hpoValue[i].children.length; j++) {
                            this.hpoValue.push(this.hpoValue[i].children[j]);
                        }
                    }
                }
            }
            if (this.hpoSearch != "") {
                if (this.hpoValue == "") {
                    query["hpo"] = this.hpoSearch;
                } else {
                    query["hpo"] = Object.keys(hposMap).join(",");
                }
            }

            //diseases
            if (this.diseaseSearch != "") {
                query["clinical-data"] = this.diseaseSearch;
            }

            // Genotypes
            var genotypes = [];
            for (var i = 0; i < this.samples.length; i++) {
                var sampleName = this.samples[i].name;
                var els = this.$.segregation.querySelectorAll("input[name='" + sampleName + "']:checked");

                var gtValues = [];
                for (var j = 0; j < els.length; j++) {
                    var el = els[j].value.split(",");
                    for (var k = 0; k < el.length; k++) {
                        gtValues.push(el[k]);
                    }
                }
                if (gtValues.length > 0) {
                    var aux = sampleName + ":" + gtValues.join(",");
                    genotypes.push(aux);
                }
            }

            if (genotypes.length > 0) {
                query.genotype = genotypes.join(";");
            }

            // Consequence Types
            var cts = this.$.filterCT.checkConsequenceTypes(1);
            if (cts != null) {
                query["annot-ct"] = cts.join(",");
            }

            // Protein Substitution Scores
            var sift = this.$.filterScores.checkSift();
            if (sift == -1) {
                return;
            } else if (sift != null) {
                query["sift"] = sift;
            }
            var polyphen = this.$.filterScores.checkPolyphen();
            if (polyphen == -1) {
                return;
            } else if (polyphen != null) {
                query["polyphen"] = polyphen;
            }
            var cadd = this.$.filterScores.checkCADD();
            if (cadd == -1) {
                return;
            } else if (cadd != null) {
                query["functional"] = "cadd_raw" + cadd;
            }

            var phastcons = this.$.filterConservation.checkPhastcons(1);
            var phylop = this.$.filterConservation.checkPhylop(1);
            var gerp = this.$.filterConservation.checkGerp();
            if (phastcons != null || phylop != null || gerp != null) {
                var conservation = [];
                if (phastcons != null) {
                    conservation.push(phastcons);
                }
                if (phylop != null) {
                    conservation.push(phylop);
                }

                if (gerp != null) {
                    conservation.push("gerp" + gerp);
                }
                query["conservation"] = conservation.join(",");
            }

            // Population Frequencies

            // Population minor allele frequency: {study}:{population}[<|>|<=|>=]{number}
            var popFreq = [];

            // 1000GENOMES_phase_3
            if (this.$["1000GENOMES_phase_3_ALL"].value != "") {
                popFreq.push(this._getPopulationQuery("1000GENOMES_phase_3", "ALL", "phase3"));
            }
            if (this.$["1000GENOMES_phase_3_AMR"].value != "") {
                popFreq.push(this._getPopulationQuery("1000GENOMES_phase_3", "AMR", "phase3"));
            }
            if (this.$["1000GENOMES_phase_3_SAS"].value != "") {
                popFreq.push(this._getPopulationQuery("1000GENOMES_phase_3", "SAS", "phase3"));
            }
            if (this.$["1000GENOMES_phase_3_EAS"].value != "") {
                popFreq.push(this._getPopulationQuery("1000GENOMES_phase_3", "EAS", "phase3"));
            }
            if (this.$["1000GENOMES_phase_3_AFR"].value != "") {
                popFreq.push(this._getPopulationQuery("1000GENOMES_phase_3", "AFR", "phase3"));
            }
            if (this.$["1000GENOMES_phase_3_EUR"].value != "") {
                popFreq.push(this._getPopulationQuery("1000GENOMES_phase_3", "EUR", "phase3"));
            }

            //ESP_6500
            if (this.$["ESP_6500_EA"].value != "") {
                popFreq.push(this._getPopulationQuery("ESP_6500", "EA", "ESP"));
            }
            if (this.$["ESP_6500_AA"].value != "") {
                popFreq.push(this._getPopulationQuery("ESP_6500", "AA", "ESP"));
            }

            if (this.$["EXAC_ALL"].value != "") {
                popFreq.push(this._getPopulationQuery("EXAC", "ALL", "exac"));
            }

            if (popFreq.length > 0) {
                query['annot-population-maf'] = popFreq.join(";");
                if (query['annot-population-maf'].indexOf("error") >= 0) {
                    return;
                }
            }

            // Type
            var types = this.$.type_op.querySelectorAll("input:checked");
            var typesAux = [];
            if (types != "") {
                for (var i = 0; i < types.length; i++) {
                    typesAux.push(types[i].value);
                }
                query["type"] = typesAux;
            }

            // Samples
            var sampleNames = [];
            for (var i = 0; i < this.samples.length; i++) {
                var sample = this.samples[i];
                sampleNames.push(sample.name);

            }

            var sampleQuery = sampleNames.join(",");
            query.returnedSamples = sampleQuery;

            query.timeout = 30000;

            this.set('query', query);

            console.log(query);
            this.search(query);
            // this.clearForm();

        },

        _getPopulationQuery: function(study, population, type) {
            var value = parseFloat(this.$[study + "_" + population].value);
            var value_op = this.$[study + "_" + population + "_op"].value;
            value = study + ":" + population + value_op + value;
            return value;
        },
        _setPopulationValue: function(population, value) {
            var aux = value.split("");
            var n = 0;
            var pop = "";
            for (i = 0; i < 5; i++) {
                if (isNaN(aux[i]) && aux[i] != '.') {
                    pop += aux[i];
                    n++;
                }
            }
            var val = "";
            if (pop.length == 4) {
                this.$[population + "_op"].value = aux[3];
            } else if (pop.length == 5) {
                this.$[population + "_op"].value = aux[3] + aux[4];
            }
            for (var i = n; i < aux.length; i++) {
                val += aux[i];
            }
            this.$[population].value = val;
        },

        search: function(query) {
            query.sid = Cookies("bioinfo_sid");
            query.skipCount = false;
            query.sort = true;

            //****//
            var sampleFiles = {};
            var filesIdAux = [];
            var me = this;
            var n = 0;

            for (var i = 0; i < this.samples.length; i++) {
                var sample = this.samples[i];
                if (sample.status == 'READY') {
                    if (sampleFiles[sample.source] == null) {
                        sampleFiles[sample.source] = 1;
                        n++;
                    }
                }
            }
            if (n > 0) {
                var studyId = this.study.id;
                OpencgaManager.studies.files({
                    id: studyId,
                    query: {
                        sid: Cookies('bioinfo_sid'),
                    },
                    request: {
                        async: true,
                        success: function(response) {
                            if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                                var result = response.response[0].result;
                                for (var i = 0; i < result.length; i++) {
                                    if (result[i].type == "FILE") {
                                        if (sampleFiles[result[i].name] != null && result[i].index != null && result[i].index.status == 'READY') {
                                            filesIdAux.push(result[i].id);
                                        }
                                    }
                                }
                                me.set('filesId', filesIdAux);
                            } else {
                                console.log(response.response[0].errorMsg);
                            }
                        },
                        error: function() {
                            console.log('Server error, try again later.');
                        }
                    }
                });
            }

        },
        filesIdChanged: function(neo, old) {
            if (neo.length > 0) {
                this.query.files = neo.join(',');
                this.query.returnedStudies = this.study.id;
                //TODO fsalavert: fix
                //            query.sessionId = Cookies("bioinfo_sid");
                var url = OpencgaManager.studies.variants({
                    id: this.study.id,
                    query: this.query,
                    request: {
                        url: true
                    }
                });

                console.log(url.length);
                if (url.length < 8000) {
                    this.url = url;
                    console.log(url);
                } else {
                    alert('Url too long');
                }
            }
        },
        loadForm: function(hf) {
            var filterName = [];

            // Samples
            if (hf.genotype != "" && hf.genotype != null) {
                var gtName = {};
                var sample_op = this.$.segregation.querySelectorAll("input");
                var gts = hf.genotype.split(";");
                for (var i = 0; i < gts.length; i++) {
                    var gt = gts[i].split(":");
                    var sampleName = gt[0];
                    var sample = gt[1].split(",");
                    for (var j = 0; j < sample_op.length; j++) {
                        if (sample_op[j].name == sampleName) {
                            for (var k = 0; k < sample.length; k++) {
                                if (sample_op[j].value.indexOf(sample[k]) >= 0) {
                                    sample_op[j].checked = true;
                                    if (gtName[sampleName] == null) {
                                        gtName[sampleName] = [];
                                    }
                                    gtName[sampleName].push(sample[k]);
                                }
                            }
                        }
                    }
                }
                filterName.push("Genotype: " + JSON.stringify(gtName).replace("{", "").replace("}", "").replace(/"/gi, "") + " ");
            }
            if (hf.somatic != "" && hf.somatic != null) {
                var els = this.$.somatic.querySelectorAll("input");
                var som = hf.somatic.split(";");
                for (var i = 0; i < som.length; i++) {
                    var n = som[i].split(":")
                    for (var j = 0; j < els.length; j++) {
                        if (els[j].name == n[0] && els[j].value == n[1]) {
                            els[j].checked = true;
                        }
                    }
                }
                filterName.push("Somatic: " + hf.somatic);
            }

            if (hf.go != "" && hf.go != null) {
                this.set('goSearch', hf.go);
                filterName.push("GO: " + hf.go);
            }
            if (hf.hpo != "" && hf.hpo != null) {
                this.set('hpoSearch', hf.hpo);
                filterName.push("HPO: " + hf.hpo);
            }
            if (hf["clinical-data"] != "" && hf["clinical-data"] != null) {
                this.set('diseaseSearch', hf["clinical-data"]);
                filterName.push("Disease: " + hf["clinical-data"]);
            }

            // Region
            // Genes
            // SNPId
            var fP = this.$.filterPosition.load(hf);
            if (fP.length > 0) {
                for (var i = 0; i < fP.length; i++) {
                    filterName.push(fP[i]);
                }
            }

            // Types
            if (hf.type != "" && hf.type != null) {
                var type_op = this.$.type_op.querySelectorAll("input");
                for (var i = 0; i < hf.type.length; i++) {
                    var type = hf.type[i];
                    for (var j = 0; j < type_op.length; j++) {
                        if (type_op[j].value.search(type) >= 0) {
                            type_op[j].checked = true;
                        }
                    }
                }
                filterName.push("Type: " + hf.type.join(",") + " ");
            }

            //Populaions
            if (hf['annot-population-maf'] != "" && hf['annot-population-maf'] != null) {
                var pops = hf['annot-population-maf'].split(";");
                for (var i = 0; i < pops.length; i++) {
                    var type = pops[i].split(":");
                    if (type[0] == "1000GENOMES_phase_3") {
                        if (pops[i].indexOf("ALL") >= 0) {
                            this._setPopulationValue("1000GENOMES_phase_3_ALL", type[1]);
                        } else if (pops[i].indexOf("AMR") >= 0) {
                            this._setPopulationValue("1000GENOMES_phase_3_AMR", type[1]);
                        } else if (pops[i].indexOf("SAS") >= 0) {
                            this._setPopulationValue("1000GENOMES_phase_3_SAS", type[1]);
                        } else if (pops[i].indexOf("EAS") >= 0) {
                            this._setPopulationValue("1000GENOMES_phase_3_EAS", type[1]);
                        } else if (pops[i].indexOf("AFR") >= 0) {
                            this._setPopulationValue("1000GENOMES_phase_3_AFR", type[1]);
                        } else if (pops[i].indexOf("EUR") >= 0) {
                            this._setPopulationValue("1000GENOMES_phase_3_EUR", type[1]);
                        }
                    } else if (type[0] == "EXAC") {
                        this._setPopulationValue("EXAC_ALL", type[1]);
                    } else if (type[0] == "ESP_6500") {
                        if (pops[i].indexOf("EA") >= 0) {
                            this._setPopulationValue("ESP_6500_EA", type[1]);
                        } else if (pops[i].indexOf("AA") >= 0) {
                            this._setPopulationValue("ESP_6500_AA", type[1]);
                        }
                    }
                }
                filterName.push("Population: " + hf['annot-population-maf'] + " ");
            }

            // Sift
            // Polyphen
            // cadd
            var fS = this.$.filterScores.load(hf);
            if (fS.length > 0) {
                for (var i = 0; i < fS.length; i++) {
                    filterName.push(fS[i]);
                }
            }

            // Phylop, Phastcons y Gerp
            var fC = this.$.filterConservation.load(hf, 1);
            if (fC.length > 0) {
                for (var i = 0; i < fC.length; i++) {
                    filterName.push(fC[i]);
                }
            }
            // Consequence Types
            var fCT = this.$.filterCT.load(hf, 1);
            if (fCT.length > 0) {
                for (var i = 0; i < fCT.length; i++) {
                    filterName.push(fCT[i]);
                }
            }

            return filterName.join(" AND ");
        },
        loadFilter: function(e) {
            e.stopPropagation();
            this.clearForm();
            this.loadForm(e.currentTarget.dataFilter);
            this.$.filterHistoryTooltip.handleClose(e);
            this.handleSubmitClick();

        },
        clearFiltersHistory: function(e) {
            e.stopPropagation();
            var me = this;
            new StvDialog().confirm("Are you sure?", function(answer) {
                if (answer == true) {
                    me.historyFilters = [];
                    delete(me.hash[me.study.id]);
                    localStorage.bioinfo_bierApp_filter_history = JSON.stringify(me.hash);
                } else {
                    return;
                }
            });

        },
        handleGenesImportBed: function(bed_file) {
            var me = this;

            var log = [];
            var line = 0;

            if (bed_file != null) {

                var _navigator = new FileNavigator(bed_file);

                var indexToStartWith = 0;

                _navigator.readSomeLines(indexToStartWith, function linesReadHandler(err, index, lines, eof, progress) {
                    if (err) {
                        return;
                    }
                    console.log(lines.length);

                    for (var i = 0; i < lines.length; i++) {
                        var line = lines[i];

                        if ((line.indexOf("#") < 0 && line.indexOf("browser") < 0 && line.indexOf("track") < 0) && line != '') {
                            var fields = line.split("\t");
                            var chr = fields[0];
                            var start = fields[1];
                            var end = fields[2];
                            var gene = {
                                name: chr + ":" + start + "-" + end,
                                chr: chr,
                                start: start,
                                end: end
                            };

                            me.regionValue += gene.name + ",";
                        }

                        line++;
                    }

                    if (eof) {
                        return;
                    }

                    _navigator.readSomeLines(index + lines.length, linesReadHandler);

                })

            }
        },
        handleImportFile: function() {
            var file = this.$.importFile.$.fileInput.files[0];

            if (!(this.$.importFile.$.validator.errorCount > 0)) {
                this.handleGenesImportBed(file);
                this.$.importComponent.hidden = true;
            }
        },
        showImportComponent: function() {
            this.$.importComponent.hidden = false;
        },
        handleCollapseAction: function(e) {
            var id = e.currentTarget.dataset.type;
            this.$[id].hidden = !this.$[id].hidden;
            if (this.$[id].hidden) {
                this[id] = "fa fa-angle-double-right minus";
            } else {
                this[id] = "fa fa-angle-double-down minus";
            }
        },
        showGO: function() {
            this.$.goPanel.hidden = !this.$.goPanel.hidden;
        },
        showHPO: function() {
            this.$.hpoPanel.hidden = !this.$.hpoPanel.hidden;
        },
        showCreatePanel: function() {
            this.$.createNewPanel.hidden = !this.$.createNewPanel.hidden;
        },
        sliderChange: function(e) {
            var id = e.currentTarget.id + "Value";
            this.set(id, e.currentTarget.value);
        },
        handleInheritanceChanged: function(e) {
            var els = this.$.segregation.querySelectorAll("input:checked");
            for (var i = 0; i < els.length; i++) {
                els[i].checked = false;
            }
            var inheritance = e.currentTarget.value;
            if (inheritance != "-") {
                this._getSegregation(this.samples, inheritance);
            }
        },
        _getSegregation: function(samples, inheritance) {
            var array = [];
            var gtName = {};
            var sample_op = this.$.segregation.querySelectorAll("input");

            if (inheritance == "dominant") {
                for (var i = 0; i < samples.length; i++) {
                    for (var j = 0; j < sample_op.length; j++) {
                        if (sample_op[j].name == samples[i].name) {
                            if (samples[i].proband == false) {
                                if (sample_op[j].value == "0/0,0|0") {
                                    sample_op[j].checked = true;
                                }
                            } else {
                                if (sample_op[j].value == "0/1,0|1,1/0,1|0" || sample_op[j].value == "1/1,1|1") {
                                    sample_op[j].checked = true;
                                }
                            }
                        }
                    }
                }
            } else if (inheritance == "recessive") {
                for (var i = 0; i < samples.length; i++) {
                    for (var j = 0; j < sample_op.length; j++) {
                        if (sample_op[j].name == samples[i].name) {
                            if (samples[i].proband == true) {
                                if (sample_op[j].value == "1/1,1|1") {
                                    sample_op[j].checked = true;
                                }
                            } else {
                                if (sample_op[j].value == "0/1,0|1,1/0,1|0") {
                                    sample_op[j].checked = true;
                                }
                                if (samples[i].father != "-" && samples[i].mother != "-") {
                                    if (sample_op[j].value == "0/0,0|0") {
                                        sample_op[j].checked = true;
                                    }
                                }
                            }
                        }
                    }
                }

            } else if (inheritance == "linkedX") {
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].gender == "Male") {
                        for (var j = 0; j < sample_op.length; j++) {
                            if (sample_op[j].name == samples[i].name) {
                                if (samples[i].proband == false) {
                                    if (sample_op[j].value == "0/0,0|0") {
                                        sample_op[j].checked = true;
                                    }
                                } else {
                                    if (sample_op[j].value == "1/1,1|1") {
                                        sample_op[j].checked = true;
                                    }
                                }
                            }
                        }
                    } else {
                        for (var j = 0; j < sample_op.length; j++) {
                            if (sample_op[j].name == samples[i].name) {
                                if (samples[i].proband == true) {
                                    if (sample_op[j].value == "1/1,1|1") {
                                        sample_op[j].checked = true;
                                    }
                                } else {
                                    if (sample_op[j].value == "0/1,0|1,1/0,1|0" || sample_op[j].value == "0/0,0|0") {
                                        sample_op[j].checked = true;
                                    }
                                }
                            }
                        }
                    }
                }
            } else if (inheritance == "linkedY") {
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].gender == "Male") {
                        for (var j = 0; j < sample_op.length; j++) {
                            if (sample_op[j].name == samples[i].name) {
                                if (samples[i].proband == false) {
                                    if (sample_op[j].value == "0/0,0|0") {
                                        sample_op[j].checked = true;
                                    }
                                } else {
                                    if (sample_op[j].value == "1/1,1|1") {
                                        sample_op[j].checked = true;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    });
</script>
